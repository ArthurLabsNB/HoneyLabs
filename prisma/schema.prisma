generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Entidad {
  id             Int       @id @default(autoincrement())
  nombre         String
  tipo           String
  correoContacto String
  telefono       String?
  direccion      String?
  fechaCreacion  DateTime  @default(now())
  almacenes      Almacen[]
  roles          Rol[]
  usuarios       Usuario[]
}

model Usuario {
  id            Int              @id @default(autoincrement())
  nombre        String
  apellidos     String
  correo        String           @unique
  contrasena    String
  googleId      String?
  tipoCuenta    String
  estado        String           @default("pendiente")
  fechaRegistro DateTime         @default(now())
  entidadId     Int?
  archivoBuffer Bytes?
  archivoNombre String?
  codigoUsado   String?
  entidad       Entidad?         @relation(fields: [entidadId], references: [id])
  almacenes     UsuarioAlmacen[]
  roles         Rol[]            @relation("RolToUsuario")
}

model Rol {
  id          Int       @id @default(autoincrement())
  nombre      String
  descripcion String?
  permisos    String
  entidadId   Int?
  entidad     Entidad?  @relation(fields: [entidadId], references: [id])
  usuarios    Usuario[] @relation("RolToUsuario")
}

model Almacen {
  id                      Int              @id @default(autoincrement())
  nombre                  String
  descripcion             String?
  imagenUrl               String?
  codigoUnico             String           @unique
  funciones               String?
  permisosPredeterminados String?
  fechaCreacion           DateTime         @default(now())
  entidadId               Int
  entidad                 Entidad          @relation(fields: [entidadId], references: [id])
  codigos                 CodigoAlmacen[]
  usuarios                UsuarioAlmacen[]
}

model UsuarioAlmacen {
  id            Int     @id @default(autoincrement())
  usuarioId     Int
  almacenId     Int
  rolEnAlmacen  String  @db.VarChar(50)
  permisosExtra String?
  almacen       Almacen @relation(fields: [almacenId], references: [id])
  usuario       Usuario @relation(fields: [usuarioId], references: [id])

  @@unique([usuarioId, almacenId])
}

model CodigoAlmacen {
  id              Int       @id @default(autoincrement())
  almacenId       Int
  codigo          String    @unique
  rolAsignado     String    @db.VarChar(50)
  permisos        String?
  usosDisponibles Int?
  activo          Boolean   @default(true)
  fechaCreacion   DateTime  @default(now())
  fechaExpiracion DateTime?
  creadoPorId     Int?
  almacen         Almacen   @relation(fields: [almacenId], references: [id])
}
